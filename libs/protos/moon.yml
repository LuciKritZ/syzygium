language: "javascript"

tasks:
  install-go-tools:
    command: "export GOBIN=$(pwd)/.bin && go install google.golang.org/protobuf/cmd/protoc-gen-go connectrpc.com/connect/cmd/protoc-gen-connect-go"
    inputs:
      - "go.mod"
      - "go.sum"
      - "tools.go"
    outputs:
      - ".bin/protoc-gen-go"
      - ".bin/protoc-gen-connect-go"
    options:
      shell: true

  generate:
    command: "export PATH=$(pwd)/.bin:$(pwd)/.venv/bin:$PATH && ./node_modules/.bin/buf generate"
    deps:
      - "install-go-tools"
    inputs:
      - "**/*.proto"
      - "buf.gen.yaml"
      - "buf.yaml"
      - "!**/.venv/**/*"
    outputs:
      - "gen"
    options:
      cache: true
      shell: true

  clean:
    command: 'rm -rf gen .venv .bin'
    options:
      shell: true
